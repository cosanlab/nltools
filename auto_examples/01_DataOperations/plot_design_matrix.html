<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Design Matrix &#8212; nltools 0.5.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css?v=45361654" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=3fadbb4a"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>

<!-- Google Analytics -->
<script>
  (function (i, s, o, g, r, a, m) {
    i["GoogleAnalyticsObject"] = r;
    (i[r] =
      i[r] ||
      function () {
        (i[r].q = i[r].q || []).push(arguments);
      }),
      (i[r].l = 1 * new Date());
    (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m);
  })(
    window,
    document,
    "script",
    "https://www.google-analytics.com/analytics.js",
    "ga"
  );

  ga("create", "UA-138438649-1", "auto");
  ga("send", "pageview");
</script>
<!-- End Google Analytics -->

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          nltools</a>
        <span class="navbar-text navbar-version pull-left"><b>0.5.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../install.html">Installation</a></li>
                <li><a href="../../api.html">API</a></li>
                <li><a href="../index.html">Tutorials</a></li>
                <li><a href="http://www.github.com/ljchang/nltools">Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">TOC <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Design Matrix</a><ul>
<li><a class="reference internal" href="#design-matrix-basics">Design Matrix Basics</a></li>
<li><a class="reference internal" href="#adding-nuisiance-covariates">Adding nuisiance covariates</a><ul>
<li><a class="reference internal" href="#legendre-polynomials">Legendre Polynomials</a></li>
<li><a class="reference internal" href="#discrete-cosine-basis-functions">Discrete Cosine Basis Functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-operations">Data operations</a><ul>
<li><a class="reference internal" href="#performing-convolution">Performing convolution</a></li>
</ul>
</li>
<li><a class="reference internal" href="#file-reading">File Reading</a><ul>
<li><a class="reference internal" href="#creating-a-design-matrix-from-an-onsets-file">Creating a Design Matrix from an onsets file</a></li>
<li><a class="reference internal" href="#creating-a-design-matrix-from-a-generic-csv-file">Creating a Design Matrix from a generic csv file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#working-with-multiple-design-matrices">Working with multiple Design Matrices</a><ul>
<li><a class="reference internal" href="#vertically-stacking-design-matrices">Vertically “stacking” Design Matrices</a></li>
<li><a class="reference internal" href="#separating-columns-during-append-operations">Separating columns during append operations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#putting-it-all-together">Putting it all together</a><ul>
<li><a class="reference internal" href="#a-realistic-workflow">A realistic workflow</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-diagnostics">Data Diagnostics</a></li>
<li><a class="reference internal" href="#estimating-a-first-level-model">Estimating a first-level model</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-01-dataoperations-plot-design-matrix-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="design-matrix">
<span id="sphx-glr-auto-examples-01-dataoperations-plot-design-matrix-py"></span><h1>Design Matrix<a class="headerlink" href="#design-matrix" title="Permalink to this heading">¶</a></h1>
<p>This tutorial illustrates how to use the Design_Matrix class to flexibly create
design matrices that can then be used with the Brain_Data class to perform
univariate regression.</p>
<p>Design Matrices can be thought of as “enhanced” pandas dataframes; they can do
everything a pandas dataframe is capable of, with some added features. Design
Matrices follow a data organization format common in many machine learning
applications such as the sci-kit learn API: 2d tables organized as observations
by features. In the context of neuro-imaging this often translates to TRs by
conditions of interest + nuisance covariates (1st level analysis), or
participants by conditions/groups (2nd level analysis).</p>
<section id="design-matrix-basics">
<h2>Design Matrix Basics<a class="headerlink" href="#design-matrix-basics" title="Permalink to this heading">¶</a></h2>
<p>Lets just create a basic toy design matrix by hand corresponding to a single participant’s data from an experiment with 12 TRs, collected at a temporal resolution of 1.5s. For this example we’ll have 4 unique “stimulus conditions” that each occur for 2 TRs (3s) with 1 TR (1.5s) of rest between events.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nltools.data</span> <span class="kn">import</span> <span class="n">Design_Matrix</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">TR</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="c1"># Design Matrices take a sampling_freq argument specified in hertz which can be converted as 1./TR</span>

<span class="n">dm</span> <span class="o">=</span> <span class="n">Design_Matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                            <span class="p">]),</span>
                            <span class="n">sampling_freq</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">TR</span><span class="p">,</span>
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;face_A&#39;</span><span class="p">,</span><span class="s1">&#39;face_B&#39;</span><span class="p">,</span><span class="s1">&#39;house_A&#39;</span><span class="p">,</span><span class="s1">&#39;house_B&#39;</span><span class="p">]</span>
                            <span class="p">)</span>
</pre></div>
</div>
<p>Notice how this look exactly like a pandas dataframe. That’s because design matrices are <em>subclasses</em> of dataframes with some extra attributes and methods.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>    face_A  face_B  house_A  house_B
0        0       0        0        0
1        0       0        0        0
2        1       0        0        0
3        1       0        0        0
4        0       0        0        0
5        0       1        0        0
6        0       1        0        0
7        0       0        0        0
8        0       0        1        0
9        0       0        1        0
10       0       0        0        0
11       0       0        0        1
12       0       0        0        1
13       0       0        0        0
14       0       0        0        0
15       0       0        0        0
16       0       0        0        0
17       0       0        0        0
18       0       0        0        0
19       0       0        0        0
20       0       0        0        0
21       0       0        0        0
</pre></div>
</div>
<p>Let’s take a look at some of that meta-data. We can see that no columns have been convolved as of yet and this design matrix has no polynomial terms (e.g. such as an intercept or linear trend).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">details</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>nltools.data.design_matrix.Design_Matrix(sampling_freq=0.6666666666666666 (hz), shape=(22, 4), multi=False, convolved=[], polynomials=[])
</pre></div>
</div>
<p>We can also easily visualize the design matrix using an SPM/AFNI/FSL style heatmap</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dm</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_design_matrix_001.png" srcset="../../_images/sphx_glr_plot_design_matrix_001.png" alt="plot design matrix" class = "sphx-glr-single-img"/></section>
<section id="adding-nuisiance-covariates">
<h2>Adding nuisiance covariates<a class="headerlink" href="#adding-nuisiance-covariates" title="Permalink to this heading">¶</a></h2>
<section id="legendre-polynomials">
<h3>Legendre Polynomials<a class="headerlink" href="#legendre-polynomials" title="Permalink to this heading">¶</a></h3>
<p>A common operation is adding an intercept and polynomial trend terms (e.g. linear and quadtratic) as nuisance regressors. This is easy to do. Consistent with other software packages, these are orthogonal Legendre poylnomials on the scale -1 to 1.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># with include_lower = True (default), 2 here means: 0-intercept, 1-linear-trend, 2-quadtratic-trend</span>
<span class="n">dm_with_nuissance</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">add_poly</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">include_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dm_with_nuissance</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_design_matrix_002.png" srcset="../../_images/sphx_glr_plot_design_matrix_002.png" alt="plot design matrix" class = "sphx-glr-single-img"/><p>We can see that 3 new columns were added to the design matrix. We can also inspect the change to the meta-data. Notice that the Design Matrix is aware of the existence of three polynomial terms now.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dm_with_nuissance</span><span class="o">.</span><span class="n">details</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>nltools.data.design_matrix.Design_Matrix(sampling_freq=0.6666666666666666 (hz), shape=(22, 7), multi=False, convolved=[], polynomials=[&#39;poly_0&#39;, &#39;poly_1&#39;, &#39;poly_2&#39;])
</pre></div>
</div>
</section>
<section id="discrete-cosine-basis-functions">
<h3>Discrete Cosine Basis Functions<a class="headerlink" href="#discrete-cosine-basis-functions" title="Permalink to this heading">¶</a></h3>
<p>Polynomial variables are not the only type of nuisance covariates that can be generated for you. Design Matrix also supports the creation of discrete-cosine basis functions ala SPM. This will create a series of filters added as new columns based on a specified duration, defaulting to 180s. Let’s create DCT filters for 20s durations in our toy data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Short filter duration for our simple example</span>
<span class="n">dm_with_cosine</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">add_dct_basis</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">dm_with_cosine</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_design_matrix_003.png" srcset="../../_images/sphx_glr_plot_design_matrix_003.png" alt="plot design matrix" class = "sphx-glr-single-img"/></section>
</section>
<section id="data-operations">
<h2>Data operations<a class="headerlink" href="#data-operations" title="Permalink to this heading">¶</a></h2>
<section id="performing-convolution">
<h3>Performing convolution<a class="headerlink" href="#performing-convolution" title="Permalink to this heading">¶</a></h3>
<p>Design Matrix makes it easy to perform convolution and will auto-ignore all columns that are consider polynomials. The default convolution kernel is the Glover (1999) HRF parameterized by the glover_hrf implementation in nipy (see nltools.externals.hrf for details). However, any arbitrary kernel can be passed as a 1d numpy array, or multiple kernels can be passed as a 2d numpy array for highly flexible convolution across many types of data (e.g. SCR).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dm_with_nuissance_c</span> <span class="o">=</span> <span class="n">dm_with_nuissance</span><span class="o">.</span><span class="n">convolve</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dm_with_nuissance_c</span><span class="o">.</span><span class="n">details</span><span class="p">())</span>
<span class="n">dm_with_nuissance_c</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_design_matrix_004.png" srcset="../../_images/sphx_glr_plot_design_matrix_004.png" alt="plot design matrix" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>nltools.data.design_matrix.Design_Matrix(sampling_freq=0.6666666666666666 (hz), shape=(22, 7), multi=False, convolved=[&#39;face_A&#39;, &#39;face_B&#39;, &#39;house_A&#39;, &#39;house_B&#39;], polynomials=[&#39;poly_0&#39;, &#39;poly_1&#39;, &#39;poly_2&#39;])
</pre></div>
</div>
<p>Design Matrix can do many different data operations in addition to convolution such as upsampling and downsampling to different frequencies, zscoring, etc. Check out the API documentation for how to use these methods.</p>
</section>
</section>
<section id="file-reading">
<h2>File Reading<a class="headerlink" href="#file-reading" title="Permalink to this heading">¶</a></h2>
<section id="creating-a-design-matrix-from-an-onsets-file">
<h3>Creating a Design Matrix from an onsets file<a class="headerlink" href="#creating-a-design-matrix-from-an-onsets-file" title="Permalink to this heading">¶</a></h3>
<p>Nltools provides basic file-reading support for 2 or 3 column formatted onset files. Users can look at the onsets_to_dm function as a template to build more complex file readers if desired or to see additional features. Nltools includes an example onsets file where each event lasted exactly 1 TR and TR = 2s. Lets use that to create a design matrix with an intercept and linear trend</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nltools.utils</span> <span class="kn">import</span> <span class="n">get_resource_path</span>
<span class="kn">from</span> <span class="nn">nltools.file_reader</span> <span class="kn">import</span> <span class="n">onsets_to_dm</span>
<span class="kn">from</span> <span class="nn">nltools.data</span> <span class="kn">import</span> <span class="n">Design_Matrix</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">TR</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">sampling_freq</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">TR</span>
<span class="n">onsetsFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_resource_path</span><span class="p">(),</span><span class="s1">&#39;onsets_example.txt&#39;</span><span class="p">)</span>
<span class="n">dm</span> <span class="o">=</span> <span class="n">onsets_to_dm</span><span class="p">(</span><span class="n">onsetsFile</span><span class="p">,</span> <span class="n">sampling_freq</span><span class="o">=</span><span class="n">sampling_freq</span><span class="p">,</span> <span class="n">run_length</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">add_poly</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dm</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_design_matrix_005.png" srcset="../../_images/sphx_glr_plot_design_matrix_005.png" alt="plot design matrix" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/runner/work/nltools/nltools/nltools/file_reader.py:79: UserWarning: Only 2 columns in file, assuming all stimuli are the same duration
  warnings.warn(
</pre></div>
</div>
</section>
<section id="creating-a-design-matrix-from-a-generic-csv-file">
<h3>Creating a Design Matrix from a generic csv file<a class="headerlink" href="#creating-a-design-matrix-from-a-generic-csv-file" title="Permalink to this heading">¶</a></h3>
<p>Alternatively you can read a generic csv file and transform it into a Design Matrix using pandas file reading capability. Here we’ll read in an example covariates file that contains the output of motion realignment estimated during a fMRI preprocessing pipeline.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">covariatesFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_resource_path</span><span class="p">(),</span><span class="s1">&#39;covariates_example.csv&#39;</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">covariatesFile</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">Design_Matrix</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">sampling_freq</span> <span class="o">=</span><span class="n">sampling_freq</span><span class="p">)</span>
<span class="n">cov</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># alter plot to scale of covs; heatmap takes Seaborn heatmap arguments</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_design_matrix_006.png" srcset="../../_images/sphx_glr_plot_design_matrix_006.png" alt="plot design matrix" class = "sphx-glr-single-img"/></section>
</section>
<section id="working-with-multiple-design-matrices">
<h2>Working with multiple Design Matrices<a class="headerlink" href="#working-with-multiple-design-matrices" title="Permalink to this heading">¶</a></h2>
<section id="vertically-stacking-design-matrices">
<h3>Vertically “stacking” Design Matrices<a class="headerlink" href="#vertically-stacking-design-matrices" title="Permalink to this heading">¶</a></h3>
<p>A common task is creating a separate design matrix for multiple runs of an experiment, (or multiple subjects) and vertically appending them to each other so that regression can be performed across all runs of an experiment. However, in order to account for run-differences its important (and common practice) to include separate run-wise polynomials (e.g. intercepts). Design Matrix’s append method is intelligent and flexible enough to keep columns separated during appending automatically.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lets use the design matrix with polynomials from above</span>
<span class="c1"># Stack &quot;run 1&quot; on top of &quot;run 2&quot;</span>
<span class="n">runs_1_and_2</span> <span class="o">=</span> <span class="n">dm_with_nuissance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm_with_nuissance</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">runs_1_and_2</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_design_matrix_007.png" srcset="../../_images/sphx_glr_plot_design_matrix_007.png" alt="plot design matrix" class = "sphx-glr-single-img"/></section>
<section id="separating-columns-during-append-operations">
<h3>Separating columns during append operations<a class="headerlink" href="#separating-columns-during-append-operations" title="Permalink to this heading">¶</a></h3>
<p>Notice that all polynomials have been kept separated for you automatically and have been renamed to reflect the fact that they come from different runs. But Design Matrix is even more flexible. Let’s say you want to estimate separate run-wise coefficients for all house stimuli too. Simply pass that into the <cite>unique_cols</cite> parameter of append.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">runs_1_and_2</span> <span class="o">=</span> <span class="n">dm_with_nuissance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm_with_nuissance</span><span class="p">,</span><span class="n">unique_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;house*&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">runs_1_and_2</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_design_matrix_008.png" srcset="../../_images/sphx_glr_plot_design_matrix_008.png" alt="plot design matrix" class = "sphx-glr-single-img"/><p>Now notice how all stimuli that begin with ‘house’ have been made into separate columns for each run. In general <cite>unique_cols</cite> can take a list of columns to keep separated or simple wild cards that either begin with a term e.g. <cite>“house*”</cite> or end with one <cite>“*house”</cite>.</p>
</section>
</section>
<section id="putting-it-all-together">
<h2>Putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this heading">¶</a></h2>
<section id="a-realistic-workflow">
<h3>A realistic workflow<a class="headerlink" href="#a-realistic-workflow" title="Permalink to this heading">¶</a></h3>
<p>Let’s combine all the examples above to build a work flow for a realistic first-level analysis fMRI analysis. This will include loading onsets from multiple experimental runs, and concatenating them into a large multi-run design matrix where we estimate a single set of coefficients for our variables of interest, but make sure we account for run-wise differences nuisiance covarites (e.g. motion) and baseline, trends, etc. For simplicity we’ll just reuse the same onsets and covariates file multiple times.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">num_runs</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">TR</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">sampling_freq</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">TR</span>
<span class="n">all_runs</span> <span class="o">=</span> <span class="n">Design_Matrix</span><span class="p">(</span><span class="n">sampling_freq</span> <span class="o">=</span> <span class="n">sampling_freq</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_runs</span><span class="p">):</span>

    <span class="c1"># 1) Load in onsets for this run</span>
    <span class="n">onsetsFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_resource_path</span><span class="p">(),</span><span class="s1">&#39;onsets_example.txt&#39;</span><span class="p">)</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">onsets_to_dm</span><span class="p">(</span><span class="n">onsetsFile</span><span class="p">,</span> <span class="n">sampling_freq</span><span class="o">=</span><span class="n">sampling_freq</span><span class="p">,</span><span class="n">run_length</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 2) Convolve them with the hrf</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">convolve</span><span class="p">()</span>

    <span class="c1"># 2) Load in covariates for this run</span>
    <span class="n">covariatesFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_resource_path</span><span class="p">(),</span><span class="s1">&#39;covariates_example.csv&#39;</span><span class="p">)</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">covariatesFile</span><span class="p">)</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">Design_Matrix</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">sampling_freq</span> <span class="o">=</span> <span class="n">sampling_freq</span><span class="p">)</span>

    <span class="c1"># 3) In the covariates, fill any NaNs with 0, add intercept and linear trends and dct basis functions</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Retain a list of nuisance covariates (e.g. motion and spikes) which we&#39;ll also want to also keep separate for each run</span>
    <span class="n">cov_columns</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">add_poly</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">add_dct_basis</span><span class="p">()</span>

    <span class="c1"># 4) Join the onsets and covariates together</span>
    <span class="n">full</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 5) Append it to the master Design Matrix keeping things separated by run</span>
    <span class="n">all_runs</span> <span class="o">=</span> <span class="n">all_runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">unique_cols</span><span class="o">=</span><span class="n">cov</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="n">all_runs</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_design_matrix_009.png" srcset="../../_images/sphx_glr_plot_design_matrix_009.png" alt="plot design matrix" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/runner/work/nltools/nltools/nltools/file_reader.py:79: UserWarning: Only 2 columns in file, assuming all stimuli are the same duration
  warnings.warn(
/home/runner/work/nltools/nltools/nltools/file_reader.py:79: UserWarning: Only 2 columns in file, assuming all stimuli are the same duration
  warnings.warn(
/home/runner/work/nltools/nltools/nltools/file_reader.py:79: UserWarning: Only 2 columns in file, assuming all stimuli are the same duration
  warnings.warn(
/home/runner/work/nltools/nltools/nltools/file_reader.py:79: UserWarning: Only 2 columns in file, assuming all stimuli are the same duration
  warnings.warn(
</pre></div>
</div>
<p>We can see the left most columns of our multi-run design matrix contain our conditions of interest (stacked across all runs), the middle columns includes separate run-wise nuisiance covariates (motion, spikes) and the right most columns contain run specific polynomials (intercept, trends, etc).</p>
</section>
</section>
<section id="data-diagnostics">
<h2>Data Diagnostics<a class="headerlink" href="#data-diagnostics" title="Permalink to this heading">¶</a></h2>
<p>Let’s actually check if our design is estimable. Design Matrix provides a few tools for cleaning up highly correlated columns (resulting in failure if trying to perform regression), replacing data, and computing collinearity. By default the <cite>clean</cite> method will drop any columns correlated at r &gt;= .95</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">all_runs_cleaned</span> <span class="o">=</span> <span class="n">all_runs</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">all_runs_cleaned</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_design_matrix_010.png" srcset="../../_images/sphx_glr_plot_design_matrix_010.png" alt="plot design matrix" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>0_poly_1 and 0_cosine_1 correlated at 0.99 which is &gt;= threshold of 0.95. Dropping 0_cosine_1
1_poly_1 and 1_cosine_1 correlated at 0.99 which is &gt;= threshold of 0.95. Dropping 1_cosine_1
2_poly_1 and 2_cosine_1 correlated at 0.99 which is &gt;= threshold of 0.95. Dropping 2_cosine_1
3_poly_1 and 3_cosine_1 correlated at 0.99 which is &gt;= threshold of 0.95. Dropping 3_cosine_1
</pre></div>
</div>
<p>Whoops, looks like above some of our polynomials and dct basis functions are highly correlated, but the clean method detected that and dropped them for us. In practice you’ll often include polynomials or dct basis functions rather than both, but this was just an illustrative example.</p>
</section>
<section id="estimating-a-first-level-model">
<h2>Estimating a first-level model<a class="headerlink" href="#estimating-a-first-level-model" title="Permalink to this heading">¶</a></h2>
<p>You can now set this multi-run Design Matrix as the <cite>X</cite> attribute of a Brain_Data object containing EPI data for these four runs and estimate a regression in just a few lines of code.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This code is commented because we don&#39;t actually have niftis loaded for the purposes of this tutorial</span>
<span class="c1"># See the other tutorials for more details on working with nifti files and Brain_Data objects</span>

<span class="c1"># Assuming you already loaded up Nifti images like this</span>
<span class="c1"># list_of_niftis = [&#39;run_1.nii.gz&#39;,&#39;run_2.nii.gz&#39;,&#39;run_3.nii.gz&#39;,&#39;run_4.nii.gz&#39;]</span>
<span class="c1"># all_run_data = Brain_Data(list_of_niftis)</span>

<span class="c1"># Set our Design Matrix to the X attribute of Brain_Data object</span>
<span class="c1"># all_run_data.X = all_runs_cleaned</span>

<span class="c1"># Run the regression</span>
<span class="c1"># results = all_run_data.regress()</span>

<span class="c1"># This will produce N beta, t, and p images</span>
<span class="c1"># where N is the number of columns in the design matrix</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 18.746 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-01-dataoperations-plot-design-matrix-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/f8c5f983fd4e6a4416a4faafa0ccf7ff/plot_design_matrix.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_design_matrix.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/f60fcc91b201d0e4382ebf3510b08d6a/plot_design_matrix.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_design_matrix.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../_sources/auto_examples/01_DataOperations/plot_design_matrix.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2023, Cosan Laboratory.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.1.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>